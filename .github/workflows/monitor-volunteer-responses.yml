name: Monitor Volunteer Responses
true:
  schedule:
  - cron: 0 * * * *
  workflow_dispatch: null
jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Authenticate GitHub CLI
      run: 'echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

        '
    - name: Run issue monitor
      id: monitor
      run: "python3 scripts/monitor_issues_v2.py\nMONITOR_EXIT=$?\necho \"monitor_exit_code=$MONITOR_EXIT\"\
        \ >> $GITHUB_OUTPUT\n\n# Check flag file\nif [ -f monitoring/changes_detected.flag\
        \ ]; then\n  CHANGES=$(jq -r '.changes_detected' monitoring/changes_detected.flag)\n\
        \  if [ \"$CHANGES\" = \"true\" ]; then\n    echo \"changes_detected=true\"\
        \ >> $GITHUB_OUTPUT\n    echo \"Changes detected in issues\"\n    exit 0\n\
        \  fi\nfi\necho \"changes_detected=false\" >> $GITHUB_OUTPUT\necho \"No changes\
        \ detected\"\n"
    - name: Post notification comment on issues with changes
      if: steps.monitor.outputs.changes_detected == 'true'
      run: "# Load change details from flag file\nCHANGES_JSON=$(cat monitoring/changes_detected.flag)\n\
        DETAILS=$(echo \"$CHANGES_JSON\" | jq -r '.details[]' 2>/dev/null || echo\
        \ \"Changes detected\")\n\n# Create notification comment\nTIMESTAMP=$(date\
        \ -u +\"%Y-%m-%d %H:%M:%S UTC\")\nCOMMENT_BODY=\"### \U0001F514 Volunteer\
        \ Response Monitor Alert\\n\\n**Detected at:** $TIMESTAMP\\n\\n**Changes:**\\\
        n\"\n\nfor detail in $DETAILS; do\n  COMMENT_BODY+=\"- $detail\\n\"\ndone\n\
        \nCOMMENT_BODY+=\"\\n**Team:** Please check the issue and respond to any volunteer\
        \ comments!\\n\\n*This is an automated notification from the volunteer response\
        \ monitoring system.*\"\n\n# Check which issues had changes\nfor issue_num\
        \ in 1 3; do\n  if grep -q \"Issue #$issue_num\" monitoring/CHANGES_DETECTED\
        \ 2>/dev/null; then\n    echo \"Posting notification comment on issue #$issue_num\"\
        \n    gh issue comment $issue_num --body \"$COMMENT_BODY\"\n  fi\ndone\n\n\
        # Also create a team notification issue\ngh issue create \\\n  --title \"\
        Volunteer Response Alert - $(date -u +'%Y-%m-%d %H:%M UTC')\" \\\n  --body\
        \ \"$COMMENT_BODY\\n\\n**Note:** Comments have been posted on the relevant\
        \ issues above. Please check and respond promptly to engage volunteers.\"\
        \ \\\n  --label \"notification,volunteer-response\" \\\n  --assignee \"ai-village-agents\"\
        \n"
    - name: Upload monitoring logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: issue-monitor-logs
        path: monitoring/
        retention-days: 7
