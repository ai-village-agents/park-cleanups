name: Monitor Volunteer Responses
'on':
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:
jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Restore issue monitor state
        uses: actions/cache/restore@v4
        with:
          path: monitoring/issue_state.json
          key: issue-state-${{ github.run_id }}
          restore-keys: |
            issue-state-
      - name: Run issue monitor
        id: monitor
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          python3 scripts/monitor_issues_v2.py

          python3 - <<'PY'
          import json
          import os
          from pathlib import Path

          flag_path = Path("monitoring/changes_detected.flag")
          detected = "false"
          if flag_path.exists():
              try:
                  data = json.loads(flag_path.read_text())
                  if str(data.get("changes_detected")).lower() == "true":
                      detected = "true"
              except Exception:
                  detected = "false"

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
              fh.write(f"changes_detected={detected}\n")
          PY
      - name: Save issue monitor state
        if: always()
        uses: actions/cache/save@v4
        with:
          path: monitoring/issue_state.json
          key: issue-state-${{ github.run_id }}

      - name: Post notification comment on issues with changes
        if: steps.monitor.outputs.changes_detected == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          python3 - <<'PY'
          import datetime
          import json
          import subprocess
          from pathlib import Path

          flag_path = Path("monitoring/changes_detected.flag")
          changes_path = Path("monitoring/CHANGES_DETECTED")

          details = []
          if flag_path.exists():
              try:
                  data = json.loads(flag_path.read_text())
                  details = data.get("details") or []
              except Exception:
                  details = []

          timestamp = datetime.datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC")
          lines = [
              "### Volunteer Response Monitor Alert",
              "",
              f"**Detected at:** {timestamp}",
              "",
              "**Changes:**",
          ]
          if details:
              lines.extend(f"- {item}" for item in details)
          else:
              lines.append("- Changes detected (no details provided)")

          comment_body = "\n".join(lines)

          changes_content = changes_path.read_text() if changes_path.exists() else ""
          targets = [num for num in (1, 3) if f"Issue #{num}" in changes_content]

          for issue_num in targets:
              print(f"Posting notification comment on issue #{issue_num}")
              subprocess.run(
                  ["gh", "issue", "comment", str(issue_num), "--body", comment_body],
                  check=True,
              )
          PY
      - name: Upload monitoring logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: issue-monitor-logs
          path: monitoring/
          retention-days: 7
