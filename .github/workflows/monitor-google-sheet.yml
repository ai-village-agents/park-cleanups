name: Monitor Google Sheet Responses
on:
  schedule:
    - cron: "*/15 * * * *"  # Every 15 minutes
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/monitor-google-sheet.yml
      - scripts/monitor_google_sheet.py
      - scripts/monitor_sheet.sh

jobs:
  monitor:
    runs-on: ubuntu-latest
    env:
      # These must be set as repository secrets:
      # GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
      # GOOGLE_SHEET_CSV_URL: ${{ secrets.GOOGLE_SHEET_CSV_URL }}
      AI_VILLAGE_AGENT_EMAILS: "gpt-5.1@agentvillage.org,gpt-5.2@agentvillage.org,claude-3.7@agentvillage.org,claude-opus-4.6@agentvillage.org,gemini-2.5-pro@agentvillage.org,gemini-3-pro@agentvillage.org,deepseek-v3.2@agentvillage.org,claude-sonnet-4.5@agentvillage.org,claude-opus-4.5@agentvillage.org,claude-haiku-4.5@agentvillage.org,gpt-5@agentvillage.org,opus-4.5-claude-code@agentvillage.org"
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests google-api-python-client google-auth-oauthlib pandas
      
      - name: Restore sheet monitor state
        uses: actions/cache/restore@v4
        with:
          path: monitoring/sheet_state.json
          # Cache keys are immutable. We restore the latest matching key and
          # save under a content-hash key (below) to avoid creating a new cache
          # on every run.
          key: sheet-state-v1-${{ runner.os }}-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            sheet-state-v1-${{ runner.os }}-${{ github.ref_name }}-
      
      - name: Run Google Sheet monitor
        id: monitor
        env:
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_SHEET_CSV_URL: ${{ secrets.GOOGLE_SHEET_CSV_URL }}
          GOOGLE_SHEET_NAME: ${{ vars.GOOGLE_SHEET_NAME || 'Form Responses 1' }}
        run: |
          python3 scripts/monitor_google_sheet.py
          
          python3 - <<'PY'
          import json
          import os
          from pathlib import Path
          
          flag_path = Path("monitoring/sheet_changes_detected.flag")
          detected = "false"
          if flag_path.exists():
              try:
                  data = json.loads(flag_path.read_text())
                  if str(data.get("changes_detected")).lower() == "true":
                      detected = "true"
              except Exception:
                  detected = "false"
          
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
              fh.write(f"changes_detected={detected}\\n")
          PY
      
      - name: Save sheet monitor state
        if: always()
        uses: actions/cache/save@v4
        with:
          path: monitoring/sheet_state.json
          key: sheet-state-v1-${{ runner.os }}-${{ github.ref_name }}-${{ hashFiles('monitoring/sheet_state.json') }}
      
      - name: Post notification to GitHub Issue
        if: steps.monitor.outputs.changes_detected == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          python3 - <<'PY'
          import datetime
          import json
          import subprocess
          from pathlib import Path
          
          flag_path = Path("monitoring/sheet_changes_detected.flag")
          changes_path = Path("monitoring/SHEET_CHANGES_DETECTED")
          
          details = []
          if flag_path.exists():
              try:
                  data = json.loads(flag_path.read_text())
                  details = data.get("details") or []
              except Exception:
                  details = []
          
          timestamp = datetime.datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC")
          lines = [
              "### Google Form Response Monitor Alert",
              "",
              f"**Detected at:** {timestamp}",
              "",
              "**New volunteer signup(s) via Google Form:**",
          f"- New response(s) detected: {len(details)}",
          
          lines.extend([
              "",
              "**Next steps:**",
              "1. Check the Google Sheet for full details",
              "2. Follow the triage runbook: `templates/first-volunteer-triage-runbook.md`",
              "3. Process the volunteer's signup per `guides/google-form-intake.md`"
          ])
          
          comment_body = "\\n".join(lines)
          
          # Post to Issues #1 and #3 (both park recruitment issues)
          for issue_num in [1, 3]:
              print(f"Posting Google Form alert to issue #{issue_num}")
              try:
                  subprocess.run(
                      ["gh", "issue", "comment", str(issue_num), "--body", comment_body],
                      check=True,
                      capture_output=True,
                      text=True
                  )
              except subprocess.CalledProcessError as e:
                  print(f"Failed to post to issue #{issue_num}: {e}")
                  print(f"Stdout: {e.stdout}")
                  print(f"Stderr: {e.stderr}")
          PY
      
      - name: Create team notification issue
        if: steps.monitor.outputs.changes_detected == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          python3 - <<'PY'
          import datetime
          import json
          import subprocess
          from pathlib import Path
          
          flag_path = Path("monitoring/sheet_changes_detected.flag")
          changes_path = Path("monitoring/SHEET_CHANGES_DETECTED")
          
          details = []
          if flag_path.exists():
              try:
                  data = json.loads(flag_path.read_text())
                  details = data.get("details") or []
              except Exception:
                  details = []
          
          timestamp = datetime.datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC")
          title = f"Google Form Response Alert - {timestamp}"
          
          lines = [
              "## Google Form Volunteer Signup Alert",
              "",
              f"**Time:** {timestamp}",
              f"**New responses:** {len(details)}",
              "",
              "**Details:**",
              f"- New response(s) detected: {len(details)}",
          
          lines.extend([
              "",
              "**Next actions:**",
              "1. Open the Google Sheet to see full details",
              "2. Follow `templates/first-volunteer-triage-runbook.md`",
              "3. Process via `guides/google-form-intake.md`",
              "",
              "**Sheet access:**",
              "- URL: configured in repository secrets",
              "- Ensure you have access to AI Village Google Workspace",
              "",
              "---",
              "*This issue was auto-generated by the Google Sheet monitor.*"
          ])
          
          body = "\\n".join(lines)
          
          # Create or update notification issue
          try:
              # Search for existing open notification issue
              result = subprocess.run(
                  ["gh", "issue", "list", "--state", "open", "--search", "Google Form Response Alert", "--json", "number,title"],
                  capture_output=True,
                  text=True,
                  check=True
              )
              issues = json.loads(result.stdout)
              
              if issues:
                  # Update existing issue
                  issue_num = issues[0]["number"]
                  print(f"Updating existing notification issue #{issue_num}")
                  subprocess.run(
                      ["gh", "issue", "comment", str(issue_num), "--body", f"New alert at {timestamp}\\n\\n{body}"],
                      check=True
                  )
              else:
                  # Create new issue
                  print("Creating new notification issue")
                  subprocess.run(
                      ["gh", "issue", "create", "--title", title, "--body", body, "--label", "monitoring,volunteer,alert"],
                      check=True
                  )
          except Exception as e:
              print(f"Failed to create/update notification issue: {e}")
          PY
      
      - name: Generate counts-only verification
        env:
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_SHEET_CSV_URL: ${{ secrets.GOOGLE_SHEET_CSV_URL }}
          GOOGLE_SHEET_NAME: ${{ vars.GOOGLE_SHEET_NAME || 'Form Responses 1' }}
        run: |
          python3 scripts/generate_counts_verification.py

      - name: Upload counts-only verification artifact
        uses: actions/upload-artifact@v4
        with:
          name: volunteer-counts-verification
          path: monitoring/volunteer_counts_verification.json
          retention-days: 7

      - name: Upload monitoring logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sheet-monitor-logs
          path: monitoring/
          retention-days: 7
